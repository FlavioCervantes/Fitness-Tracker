<!doctype html>
<html>

  <head>
    <meta charset="utf-8">
    <title>Fitness Tracker Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
  </head>

  <body>
    <%- include("partials/header.ejs") %>

      <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand" href="/dashboard">Dashboard</a>
          <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/exercises">Exercises</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/progress">Progress</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout">Logout</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <div class="container mt-4">
        <!-- Display Inspo here -->
        <section class="card mb-4" id="quote-card">
          <div class="card-body">
            <h2 class="card-title">Daily Inspiration</h2>
            <p id="insp-quote"><%- quote.content %></p>
            <small id="quote-author" class="text-muted">— <%= quote.author %></small>
          </div>
        </section>

        <!-- Log workout card -->
        <section class="card mb-4">
          <div class="card-body">
            <h2 class="card-title">Log Your Workout</h2>
            <form id="workout-form" action="/workout/log" method="POST">
              <div class="mb-3">
                <label for="workout-date" class="form-label">Date</label>
                <input type="date" id="workout-date" name="date" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="workout-duration" class="form-label">Duration (minutes)</label>
                <input type="number" id="workout-duration" name="duration" class="form-control" required>
              </div>

              <!-- exercise list -->
              <h3>Exercises (you must add at least one)</h3>
              <div id="exercise-list"></div>

              <button type="submit" class="btn btn-primary">Save Workout</button>
            </form>
          </div>
        </section>

        <!-- update profile card -->
        <section class="card mb-4">
          <div class="card-body">
            <h2 class="card-title">Update Profile</h2>

            <form id="profile-form" action="/profile/update" method="POST">
              <div class="mb-3">
                <label for="profile-email" class="form-label">Email</label>
                <input type="email" id="profile-email" name="email" class="form-control" value="<%= user.email %>"
                  required>
              </div>

              <div class="mb-3">
                <label for="profile-height" class="form-label">Height (inches)</label>
                <input type="number" id="profile-height" name="height" class="form-control"
                  value="<%= user.height || '' %>" required>
              </div>

              <div class="mb-3">
                <label for="profile-weight" class="form-label">Weight (lbs)</label>
                <input type="number" id="profile-weight" name="weight" class="form-control"
                  value="<%= user.weight || '' %>" required min="1" max="1500">
              </div>

              <button type="submit" class="btn btn-primary">Update Profile</button>
            </form>
          </div>
        </section>

        <!-- Workout History Card -->
        <!-- I added options to update/delete here -->
        <section class="card mb-4">
          <div class="card-body">
            <h2 class="card-title">Recent Workouts</h2>
            <div id="recent-workouts">
              <% if (workouts && workouts.length) { %>
                <ul class="list-group">
                  <% workouts.forEach(function(w){ %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>
                          <%= new Date(w.date).toLocaleDateString() %>
                        </strong> —
                        <%= w.duration %> minutes —
                          <%= w.exerciseCount %> exercises
                      </div>
                      <div>
                        <!-- edit option -->
                        <a href="/workout/edit/<%= w.workoutId %>" class="btn btn-sm btn-success me-2">
                          <i class="bi bi-pencil-square"></i> Edit
                        </a>
                        <!-- delete option -->
                        <button class="btn btn-sm btn-danger delete-workout-btn" data-workout-id="<%= w.workoutId %>">
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              <% } 
                else { %>
                  <p>No workouts yet. Log your first workout above.</p>
                <% } %>
            </div>
          </div>
        </section>
      </div>

      <%- include("partials/footer.ejs") %>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/script.js"></script>

        <!-- to delete a workout -->
        <script>
          // delete buttonadded to each workout
          document.querySelectorAll('.delete-workout-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
              // confirm deletion
              if (confirm('This cannot be undone. Are you sure you want to delete this workout?')) {
                const workoutId = this.dataset.workoutId;

                try {
                  // delete request to server
                  const response = await fetch(`/workout/delete/${workoutId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                  });

                  const result = await response.json();

                  if (result.success) {
                    alert('Workout deleted successfully!');
                    location.reload(); // Refresh page to show updated list
                  } 
                  else {
                    alert('Failed to delete workout.');
                  }
                } 
                catch (error) {
                  console.error('Error:', error);
                  alert('An error occurred.');
                }
              }
            });
          });
        </script>
  </body>

</html>